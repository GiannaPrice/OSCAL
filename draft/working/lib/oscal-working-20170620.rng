<?xml version="1.0" encoding="UTF-8"?>
<grammar ns="http://scap.nist.gov/schema/oscal" xmlns="http://relaxng.org/ns/structure/1.0" datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes">
  <!-- We can have a catalog, or we can have only declarations for catalogs -->
  <start>
    <choice>
      <ref name="catalog"/>
      <ref name="declarations"/>
    </choice>
  </start>
  <!--
    start = element oscal-catalog { declarations, catalog } 
    have initial sections
    declare   - declares local parameters and settings including constraints on controls
                (enumerated values for properties, regexes and what not)
    also declares bindings to authorities (e.g. sources for transclusion/comparison)?
  -->
  <define name="catalog">
    <element name="catalog">
      <ref name="title"/>
      <optional>
        <ref name="declarations"/>
      </optional>
      <zeroOrMore>
        <ref name="section"/>
      </zeroOrMore>
      <choice>
        <oneOrMore>
          <ref name="group"/>
        </oneOrMore>
        <oneOrMore>
          <ref name="control"/>
        </oneOrMore>
      </choice>
      <zeroOrMore>
        <ref name="section"/>
      </zeroOrMore>
      <optional>
        <ref name="references"/>
      </optional>
    </element>
  </define>
  <!-- do we want a 'runtime' element for runtime bindings? such as parameters -->
  <!--
    declarations includes declarations for control types, parameters (names/types),
    authorities (source data for transclusion etc. etc.)
  -->
  <define name="declarations">
    <element name="declarations">
      <optional>
        <attribute name="href"/>
      </optional>
      <ref name="decls"/>
    </element>
  </define>
  <define name="decls">
    <zeroOrMore>
      <choice>
        <ref name="parameter"/>
        <ref name="property"/>
        <ref name="statement"/>
      </choice>
    </zeroOrMore>
  </define>
  <!-- parameter declarations expose names and default values for parameters within the control type -->
  <define name="parameter">
    <element name="parameter">
      <ref name="nameAttr"/>
      <ref name="contextAttr"/>
      <optional>
        <choice>
          <ref name="regex"/>
          <ref name="value"/>
          <oneOrMore>
            <ref name="choice"/>
          </oneOrMore>
        </choice>
      </optional>
    </element>
  </define>
  <!-- property may contain only id, only regex, both id and regex, or (sequence of) values -->
  <define name="property">
    <element name="property">
      <ref name="nameAttr"/>
      <ref name="contextAttr"/>
      <optional>
        <ref name="required"/>
      </optional>
      <choice>
        <group>
          <optional>
            <element name="identifier">
              <empty/>
            </element>
          </optional>
          <optional>
            <choice>
              <ref name="regex"/>
              <ref name="autonum"/>
            </choice>
          </optional>
        </group>
        <zeroOrMore>
          <ref name="value"/>
        </zeroOrMore>
      </choice>
    </element>
  </define>
  <!--
    on 'property and possibly 'parameter',
    element limit { nameAttr, text } w/ @type= upper-bound-inclusive, lower-bound-exclusive, (w/ inclusive/exclusive etc.)
  -->
  <define name="regex">
    <element name="regex">
      <text/>
    </element>
  </define>
  <define name="value">
    <element name="value">
      <text/>
    </element>
  </define>
  <define name="autonum">
    <empty/>
  </define>
  <!-- element autonum { text } -->
  <define name="statement">
    <element name="statement">
      <ref name="nameAttr"/>
      <ref name="contextAttr"/>
      <optional>
        <ref name="required"/>
      </optional>
    </element>
  </define>
  <define name="required">
    <element name="required">
      <empty/>
    </element>
  </define>
  <!-- now for elements themselves -->
  <define name="group">
    <element name="group">
      <ref name="idAttr"/>
      <ref name="typeAttr"/>
      <optional>
        <ref name="title"/>
      </optional>
      <zeroOrMore>
        <ref name="prop"/>
      </zeroOrMore>
      <zeroOrMore>
        <ref name="anyKindofStatement"/>
      </zeroOrMore>
      <choice>
        <zeroOrMore>
          <ref name="group"/>
        </zeroOrMore>
        <zeroOrMore>
          <ref name="control"/>
        </zeroOrMore>
      </choice>
      <zeroOrMore>
        <ref name="section"/>
      </zeroOrMore>
      <optional>
        <ref name="references"/>
      </optional>
    </element>
  </define>
  <define name="section">
    <element name="div">
      <ref name="idAttr"/>
      <ref name="typeAttr"/>
      <ref name="title"/>
      <ref name="prose"/>
      <zeroOrMore>
        <ref name="section"/>
      </zeroOrMore>
      <optional>
        <ref name="references"/>
      </optional>
    </element>
  </define>
  <define name="control">
    <element name="control">
      <ref name="idAttr"/>
      <ref name="typeAttr"/>
      <optional>
        <ref name="title"/>
      </optional>
      <zeroOrMore>
        <ref name="param"/>
      </zeroOrMore>
      <zeroOrMore>
        <ref name="prop"/>
      </zeroOrMore>
      <optional>
        <ref name="desc"/>
      </optional>
      <zeroOrMore>
        <ref name="anyKindofStatement"/>
      </zeroOrMore>
      <optional>
        <ref name="extensions"/>
      </optional>
      <optional>
        <ref name="references"/>
      </optional>
    </element>
  </define>
  <define name="title">
    <element name="title">
      <zeroOrMore>
        <choice>
          <text/>
          <ref name="q"/>
        </choice>
      </zeroOrMore>
    </element>
  </define>
  <!--
    param is like its declaration, but simpler
    permits bindings to assign and select elements w/in controls
    i.e. local override of a default assignment in a parameter declaration
    or on-the-fly declaration of new parameters for a control
    (since params are not currently required to be declared
  -->
  <define name="param">
    <empty/>
  </define>
  <!-- element param { nameAttr, mix } -->
  <define name="prop">
    <element name="prop">
      <ref name="nameAttr"/>
      <ref name="whatnot"/>
    </element>
  </define>
  <!-- on prop, not(@name = ../(* except current())/@name) -->
  <define name="desc">
    <element name="desc">
      <ref name="prose"/>
    </element>
  </define>
  <!--
    stmt is a bit of controlled prose: its title is implicit in its name
    e.g. stmt[@name='objectives'] might be displayed with title "Objectives:"
  -->
  <define name="anyKindofStatement">
    <choice>
      <ref name="stmt"/>
      <ref name="purpose"/>
      <ref name="guidance"/>
      <ref name="decision"/>
      <ref name="information"/>
      <ref name="remarks"/>
    </choice>
  </define>
  <define name="stmt">
    <element name="stmt">
      <optional>
        <ref name="nameAttr"/>
      </optional>
      <ref name="prose"/>
    </element>
  </define>
  <!-- syntax sugar for stmt[@role='purpose'] for "Objective/s" etc. -->
  <define name="purpose">
    <element name="purpose">
      <ref name="prose"/>
    </element>
  </define>
  <!-- syntax sugar for stmt[@role='guidance'] for "Supplemental Guidance" etc. -->
  <define name="guidance">
    <element name="guidance">
      <ref name="prose"/>
    </element>
  </define>
  <!-- syntax sugar for stmt[@role='decision'] -->
  <define name="decision">
    <element name="decision">
      <ref name="prose"/>
    </element>
  </define>
  <!-- syntax sugar for stmt[@role='information'], other-info, etc. -->
  <define name="information">
    <element name="information">
      <ref name="prose"/>
    </element>
  </define>
  <!-- syntax sugar for stmt[@role='remarks'] -->
  <define name="remarks">
    <element name="remarks">
      <ref name="prose"/>
    </element>
  </define>
  <define name="prose">
    <zeroOrMore>
      <choice>
        <ref name="ul"/>
        <ref name="ol"/>
        <ref name="p"/>
      </choice>
    </zeroOrMore>
  </define>
  <!--
    cluster = element cluster { control+ | prop+ | ref+ }
    on group, not(*/@name != */@name) ie all names must be the same
  -->
  <define name="extensions">
    <oneOrMore>
      <ref name="group"/>
    </oneOrMore>
  </define>
  <define name="references">
    <element name="references">
      <oneOrMore>
        <ref name="ref"/>
      </oneOrMore>
    </element>
  </define>
  <define name="ref">
    <element name="ref">
      <ref name="idAttr"/>
      <zeroOrMore>
        <choice>
          <ref name="std"/>
          <ref name="citation"/>
        </choice>
      </zeroOrMore>
    </element>
  </define>
  <!-- add mixed-citation or equivalent -->
  <define name="std">
    <element name="std">
      <optional>
        <attribute name="href">
          <data type="anyURI"/>
        </attribute>
      </optional>
      <ref name="mix"/>
    </element>
  </define>
  <define name="citation">
    <element name="citation">
      <optional>
        <attribute name="href">
          <data type="anyURI"/>
        </attribute>
      </optional>
      <ref name="mix"/>
    </element>
  </define>
  <define name="p">
    <element name="p">
      <ref name="idAttr"/>
      <ref name="whatnot"/>
    </element>
  </define>
  <define name="ol">
    <element name="ol">
      <oneOrMore>
        <element name="li">
          <ref name="whatnot"/>
        </element>
      </oneOrMore>
    </element>
  </define>
  <define name="ul">
    <element name="ul">
      <oneOrMore>
        <element name="li">
          <ref name="whatnot"/>
        </element>
      </oneOrMore>
    </element>
  </define>
  <define name="idAttr">
    <optional>
      <attribute name="id">
        <data type="ID"/>
      </attribute>
    </optional>
  </define>
  <define name="nameAttr">
    <optional>
      <attribute name="role"/>
    </optional>
  </define>
  <define name="typeAttr">
    <optional>
      <attribute name="type"/>
    </optional>
  </define>
  <define name="contextAttr">
    <attribute name="where"/>
  </define>
  <!-- nameAttr = attribute name { xsd:NCName } -->
  <!-- html! -->
  <define name="whatnot">
    <zeroOrMore>
      <choice>
        <ref name="semantical"/>
        <ref name="ol"/>
        <ref name="mix"/>
      </choice>
    </zeroOrMore>
  </define>
  <define name="mix">
    <zeroOrMore>
      <choice>
        <ref name="inlines"/>
        <text/>
      </choice>
    </zeroOrMore>
  </define>
  <define name="inlines">
    <choice>
      <ref name="q"/>
      <ref name="code"/>
      <element name="em">
        <text/>
      </element>
      <element name="xref">
        <optional>
          <attribute name="href"/>
        </optional>
        <text/>
      </element>
    </choice>
  </define>
  <define name="q">
    <element name="q">
      <text/>
    </element>
  </define>
  <!-- A bit of code (perhaps capable of evaluation in the correct context) -->
  <define name="code">
    <element name="code">
      <optional>
        <attribute name="type"/>
      </optional>
      <ref name="mix"/>
    </element>
  </define>
  <!-- not html! -->
  <define name="semantical">
    <choice>
      <ref name="withdrawn"/>
      <ref name="assign"/>
      <ref name="select"/>
    </choice>
  </define>
  <!-- A placeholder status report typically with a cross-reference -->
  <define name="withdrawn">
    <element name="withdrawn">
      <zeroOrMore>
        <choice>
          <ref name="inlines"/>
          <text/>
        </choice>
      </zeroOrMore>
    </element>
  </define>
  <!-- A value to be assigned by responder, possibly via a param (parameter) or parameter declaration -->
  <define name="assign">
    <element name="assign">
      <optional>
        <ref name="paramAttr"/>
      </optional>
      <ref name="mix"/>
    </element>
  </define>
  <!-- A selection to be made by responder -->
  <define name="select">
    <element name="select">
      <optional>
        <ref name="paramAttr"/>
      </optional>
      <zeroOrMore>
        <ref name="choice"/>
      </zeroOrMore>
    </element>
  </define>
  <!--
    Within a selection, a choice
    unlike 'value', choice may have inline stuff as well as 'assign' elements
  -->
  <define name="choice">
    <element name="choice">
      <zeroOrMore>
        <choice>
          <ref name="assign"/>
          <ref name="mix"/>
        </choice>
      </zeroOrMore>
    </element>
  </define>
  <define name="paramAttr">
    <optional>
      <attribute name="use-param"/>
    </optional>
  </define>
</grammar>
